name: Device Cloud Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  device-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Run Device Cloud Test
        id: devicecloud
        uses: devicecloud-dev/device-cloud-for-maestro@v2
        with:
          api-key: ${{ secrets.DCD_API_KEY }}
          app-binary-id: 9424cc28-de18-4aed-86d9-0f3459f933ad
          flows: tests/
          android-device: pixel-6
          json-file: true

      - name: Save Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '*_dcd.json'

      - name: Notify Feishu
        if: always()
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          STATUS: ${{ steps.devicecloud.outputs.DEVICE_CLOUD_UPLOAD_STATUS }}
          CONSOLE_URL: ${{ steps.devicecloud.outputs.DEVICE_CLOUD_CONSOLE_URL }}
        run: |
          # æ ¹æ®çŠ¶æ€è®¾ç½®é¢œè‰²
          if [ "$STATUS" = "PASSED" ]; then
            COLOR="green"
          else
            COLOR="red"
          fi

          # è·å–æ„å»ºæ—¶é—´
          BUILD_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')

          # å‘é€é£ä¹¦é€šçŸ¥
          curl -X POST "$FEISHU_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "interactive",
              "card": {
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": "ğŸ“Š Device Cloud æµ‹è¯•æŠ¥å‘Š"
                  },
                  "template": "'"$COLOR"'"
                },
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "tag": "plain_text",
                      "content": "â° æ„å»ºæ—¶é—´: '"$BUILD_TIME"'"
                    }
                  },
                  {
                    "tag": "action",
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "ğŸ”— æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š"
                        },
                        "type": "primary",
                        "url": "'"$CONSOLE_URL"'"
                      }
                    ]
                  }
                ]
              }
            }'